name: Blog Social â€” Post to Bluesky & LinkedIn

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      slug:
        description: "Blog slug to post manually (example: 2026-02-20-engine-daily-update)"
        required: true
        type: string

# â”€â”€ Permissions â”€â”€
permissions:
  contents: read

jobs:
  post-social:
    # Only run for merged, automated daily-blog PRs.
    # This ensures social posting is chained to the Daily Blog workflow output.
    if: >
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.pull_request.merged == true &&
        startsWith(github.event.pull_request.head.ref, 'blog/') &&
        startsWith(github.event.pull_request.title, 'blog: engine daily update') &&
        contains(github.event.pull_request.labels.*.name, 'blog') &&
        contains(github.event.pull_request.labels.*.name, 'automated')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€ Extract post metadata â”€â”€
      - name: Extract post info
        id: post
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SLUG="${{ inputs.slug }}"
          else
            BRANCH_REF="${{ github.event.pull_request.head.ref }}"
            SLUG="${BRANCH_REF#blog/}"
          fi

          SLUG=$(echo "$SLUG" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')
          POST_FILE="content/blog/${SLUG}.md"

          if [ ! -f "$POST_FILE" ]; then
            echo "::warning::Expected blog post not found at ${POST_FILE} â€” skipping social"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "found=true" >> "$GITHUB_OUTPUT"

          # Parse front matter (simple grep â€” no deps needed)
          TITLE=$(grep '^title:' "$POST_FILE" | sed 's/^title: *"//;s/"$//')
          SUMMARY=$(grep '^summary:' "$POST_FILE" | sed 's/^summary: *"//;s/"$//')
          SLUG_FROM_FILE=$(grep '^slug:' "$POST_FILE" | sed 's/^slug: *"//;s/"$//')

          if [ -n "$SLUG_FROM_FILE" ]; then
            SLUG="$SLUG_FROM_FILE"
          fi

          if [ -z "$TITLE" ] || [ -z "$SUMMARY" ] || [ -z "$SLUG" ]; then
            echo "::warning::Failed to parse required front matter fields (title/summary/slug) from ${POST_FILE}"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "title=${TITLE}" >> "$GITHUB_OUTPUT"
          echo "summary=${SUMMARY}" >> "$GITHUB_OUTPUT"
          echo "slug=${SLUG}" >> "$GITHUB_OUTPUT"

          # Build the public URL (adjust domain as needed)
          echo "url=https://phoenixengine.dev/blog/${SLUG}" >> "$GITHUB_OUTPUT"

      # â”€â”€ Bluesky â”€â”€
      - name: Post to Bluesky
        if: >
          steps.post.outputs.found == 'true' &&
          vars.BLOG_SOCIAL_BLUESKY == 'true'
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
        run: |
          TITLE="${{ steps.post.outputs.title }}"
          SUMMARY="${{ steps.post.outputs.summary }}"
          URL="${{ steps.post.outputs.url }}"

          if [ -z "${BLUESKY_HANDLE}" ] || [ -z "${BLUESKY_APP_PASSWORD}" ]; then
            echo "::warning::BLUESKY_HANDLE or BLUESKY_APP_PASSWORD is missing â€” skipping Bluesky post"
            exit 0
          fi

          # Bluesky post text max is 300 chars; trim summary dynamically so post always succeeds.
          TAGS="#PhoenixEngine #GameDev #GodotEngine #OpenSource"
          PREFIX="ðŸ¤– ${TITLE}"

          # +6 accounts for separators in final format:
          # PREFIX\n\nSUMMARY\n\nURL\n\nTAGS
          FIXED_LEN=$(( ${#PREFIX} + ${#URL} + ${#TAGS} + 6 ))
          AVAILABLE=$(( 300 - FIXED_LEN ))

          SUMMARY_TRIMMED="$SUMMARY"
          if [ "$AVAILABLE" -lt 0 ]; then
            # Very long title/url edge case.
            SUMMARY_TRIMMED=""
          elif [ ${#SUMMARY_TRIMMED} -gt "$AVAILABLE" ]; then
            if [ "$AVAILABLE" -gt 1 ]; then
              SUMMARY_TRIMMED="${SUMMARY_TRIMMED:0:$((AVAILABLE-1))}â€¦"
            else
              SUMMARY_TRIMMED=""
            fi
          fi

          TEXT=$(printf "%s\n\n%s\n\n%s\n\n%s" "$PREFIX" "$SUMMARY_TRIMMED" "$URL" "$TAGS")

          # Authenticate with Bluesky
          AUTH_STATUS=$(curl -sS -X POST "https://bsky.social/xrpc/com.atproto.server.createSession" \
            -H "Content-Type: application/json" \
            -d "{\"identifier\": \"${BLUESKY_HANDLE}\", \"password\": \"${BLUESKY_APP_PASSWORD}\"}" \
            -o /tmp/bsky-auth.json \
            -w "%{http_code}") || AUTH_STATUS="000"

          AUTH=$(cat /tmp/bsky-auth.json)

          DID=$(echo "$AUTH" | jq -r '.did // empty')
          ACCESS_JWT=$(echo "$AUTH" | jq -r '.accessJwt // empty')

          if [ "$AUTH_STATUS" != "200" ] || [ -z "$DID" ] || [ -z "$ACCESS_JWT" ]; then
            echo "::warning::Bluesky authentication failed (HTTP ${AUTH_STATUS})"
            echo "$AUTH" | jq .
            exit 0  # Don't fail the workflow over social
          fi

          # Create post
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          POST_STATUS=$(curl -sS -X POST "https://bsky.social/xrpc/com.atproto.repo.createRecord" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${ACCESS_JWT}" \
            -d "$(jq -n \
              --arg did "$DID" \
              --arg text "$TEXT" \
              --arg now "$NOW" \
              '{
                repo: $did,
                collection: "app.bsky.feed.post",
                record: {
                  "$type": "app.bsky.feed.post",
                  text: $text,
                  createdAt: $now
                }
              }')" \
            -o /tmp/bsky-post.json \
            -w "%{http_code}") || POST_STATUS="000"

          RESPONSE=$(cat /tmp/bsky-post.json)

          if [ "$POST_STATUS" != "200" ]; then
            echo "::warning::Bluesky post failed (HTTP ${POST_STATUS})"
            echo "$RESPONSE" | jq .
            exit 0
          fi

          echo "Bluesky post created:"
          echo "$RESPONSE" | jq -r '.uri // "unknown"'

      # â”€â”€ LinkedIn â”€â”€
      - name: Post to LinkedIn
        if: >
          steps.post.outputs.found == 'true' &&
          vars.BLOG_SOCIAL_LINKEDIN == 'true'
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_PERSON_URN: ${{ secrets.LINKEDIN_PERSON_URN }}
        run: |
          TITLE="${{ steps.post.outputs.title }}"
          SUMMARY="${{ steps.post.outputs.summary }}"
          URL="${{ steps.post.outputs.url }}"

          TEXT="ðŸ¤– ${TITLE}

          ${SUMMARY}

          Read more: ${URL}

          #PhoenixEngine #GameDev #GodotEngine #OpenSource"

          RESPONSE=$(curl -s -X POST "https://api.linkedin.com/v2/ugcPosts" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LINKEDIN_ACCESS_TOKEN}" \
            -H "X-Restli-Protocol-Version: 2.0.0" \
            -d "$(jq -n \
              --arg urn "$LINKEDIN_PERSON_URN" \
              --arg text "$TEXT" \
              --arg url "$URL" \
              --arg title "$TITLE" \
              '{
                author: $urn,
                lifecycleState: "PUBLISHED",
                specificContent: {
                  "com.linkedin.ugc.ShareContent": {
                    shareCommentary: {text: $text},
                    shareMediaCategory: "ARTICLE",
                    media: [{
                      status: "READY",
                      originalUrl: $url,
                      title: {text: $title}
                    }]
                  }
                },
                visibility: {
                  "com.linkedin.ugc.MemberNetworkVisibility": "PUBLIC"
                }
              }')")

          echo "LinkedIn post created:"
          echo "$RESPONSE" | jq -r '.id // "unknown"'
